image: maven:3.8-openjdk-17-slim

stages:
  - build
  - test-and-analyze
  - deploy


build:
  stage: build
  script:
    - echo "Iniciando build do projeto..."
    - mvn clean install -DskipTests
  artifacts:
    paths:
      - target/*.jar
  only:
    - main
    - merge_requests


test-and-analyze:
  stage: test-and-analyze

  dependencies:
    - build
  script:
    - echo "Iniciando testes e analise com SonarCloud..."


    - mvn clean verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -Dsonar.organization=$SONAR_ORGANIZATION -Dsonar.projectKey=$SONAR_PROJECT_KEY -Dsonar.host.url=$SONAR_HOST_URL -Dsonar.token=$SONAR_TOKEN

  only:
    - main
    - merge_requests


deploy-to-heroku:
  stage: deploy
  image: ruby:3.2
  dependencies:
    - build
  script:
    - echo "Iniciando deploy no Heroku..."

    - gem install dpl

    - dpl --provider=heroku --app=$HEROKU_APP_NAME --api-key=$HEROKU_API_KEY
    - echo "Deploy conclu√≠do!"

  only:
    - main

  when: on_success